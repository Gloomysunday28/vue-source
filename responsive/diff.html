<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>组件更新 | Vue源码内幕解析</title>
    <meta name="generator" content="VuePress 1.5.2">
    
    <meta name="description" content="Vue源码内幕解析">
    <link rel="preload" href="/vue-source/assets/css/0.styles.5054cea6.css" as="style"><link rel="preload" href="/vue-source/assets/js/app.b682844e.js" as="script"><link rel="preload" href="/vue-source/assets/js/2.f913fa43.js" as="script"><link rel="preload" href="/vue-source/assets/js/3.eb811a71.js" as="script"><link rel="preload" href="/vue-source/assets/js/6.31106f99.js" as="script"><link rel="preload" href="/vue-source/assets/js/4.cf36d000.js" as="script"><link rel="prefetch" href="/vue-source/assets/js/10.033d080d.js"><link rel="prefetch" href="/vue-source/assets/js/11.aa740a9b.js"><link rel="prefetch" href="/vue-source/assets/js/12.15da80df.js"><link rel="prefetch" href="/vue-source/assets/js/13.c8ed7de3.js"><link rel="prefetch" href="/vue-source/assets/js/14.dea19874.js"><link rel="prefetch" href="/vue-source/assets/js/15.ebdcdf71.js"><link rel="prefetch" href="/vue-source/assets/js/16.1be48510.js"><link rel="prefetch" href="/vue-source/assets/js/17.259fc35a.js"><link rel="prefetch" href="/vue-source/assets/js/18.a818ea63.js"><link rel="prefetch" href="/vue-source/assets/js/19.2410a8bb.js"><link rel="prefetch" href="/vue-source/assets/js/20.3cff52e4.js"><link rel="prefetch" href="/vue-source/assets/js/21.c7faafd4.js"><link rel="prefetch" href="/vue-source/assets/js/22.3606a35c.js"><link rel="prefetch" href="/vue-source/assets/js/23.973f44b3.js"><link rel="prefetch" href="/vue-source/assets/js/24.0e5e1f0e.js"><link rel="prefetch" href="/vue-source/assets/js/25.4efd2107.js"><link rel="prefetch" href="/vue-source/assets/js/26.ca568817.js"><link rel="prefetch" href="/vue-source/assets/js/27.ee5eb0ca.js"><link rel="prefetch" href="/vue-source/assets/js/28.15aac3f6.js"><link rel="prefetch" href="/vue-source/assets/js/29.f048fc6c.js"><link rel="prefetch" href="/vue-source/assets/js/30.ace3c4f9.js"><link rel="prefetch" href="/vue-source/assets/js/5.66ec1e3d.js"><link rel="prefetch" href="/vue-source/assets/js/7.e554442f.js"><link rel="prefetch" href="/vue-source/assets/js/8.d42fc26d.js"><link rel="prefetch" href="/vue-source/assets/js/9.87994248.js">
    <link rel="stylesheet" href="/vue-source/assets/css/0.styles.5054cea6.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/vue-source/" class="home-link router-link-active"><!----> <span class="site-name">Vue源码内幕解析</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/vue-source/" class="nav-link">
  Vue2.x源码解析
</a></div><div class="nav-item"><a href="https://github.com/Gloomysunday28/vue-source" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/vue-source/" class="nav-link">
  Vue2.x源码解析
</a></div><div class="nav-item"><a href="https://github.com/Gloomysunday28/vue-source" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>介绍</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/vue-source/" aria-current="page" class="sidebar-link">Vue2.x导读介绍</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/vue-source/#导言" class="sidebar-link">导言</a></li><li class="sidebar-sub-header"><a href="/vue-source/#vue2-x的学习方式" class="sidebar-link">Vue2.x的学习方式</a></li><li class="sidebar-sub-header"><a href="/vue-source/#vue3-x的学习方式" class="sidebar-link">Vue3.x的学习方式</a></li><li class="sidebar-sub-header"><a href="/vue-source/#温馨提示" class="sidebar-link">温馨提示</a></li></ul></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Vue全局API</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/vue-source/initGlobalAPI/" class="sidebar-link">initGlobalAPI</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/vue-source/initGlobalAPI/assertTypes.html" class="sidebar-link">vue.component注册函数</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/vue-source/initGlobalAPI/assertTypes.html#结合initglobalapi里assert-types的调用" class="sidebar-link">结合initGlobalAPI里ASSERT_TYPES的调用</a></li><li class="sidebar-sub-header"><a href="/vue-source/initGlobalAPI/assertTypes.html#initassetregisters" class="sidebar-link">initAssetRegisters</a></li></ul></li><li><a href="/vue-source/initGlobalAPI/builtInComponents.html" class="sidebar-link">内部组件合并</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/vue-source/initGlobalAPI/builtInComponents.html#builtincomponents" class="sidebar-link">builtInComponents</a></li></ul></li><li><a href="/vue-source/initGlobalAPI/initUse.html" class="sidebar-link">初始化Vue.use</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/vue-source/initGlobalAPI/initUse.html#步骤" class="sidebar-link">步骤</a></li></ul></li><li><a href="/vue-source/initGlobalAPI/initMixin.html" class="sidebar-link">Vue.mixin函数</a></li><li><a href="/vue-source/initGlobalAPI/toSumUp.html" class="sidebar-link">总结</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Vue函数</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/vue-source/vue/" class="sidebar-link">Vue函数定义</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Vue初始化</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/vue-source/init/" class="sidebar-link">初始化</a></li><li><a href="/vue-source/init/mergeOptions.html" class="sidebar-link">合并资源</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/vue-source/init/mergeOptions.html#resolveconstructoroptions" class="sidebar-link">resolveConstructorOptions</a></li><li class="sidebar-sub-header"><a href="/vue-source/init/mergeOptions.html#mergeoptions" class="sidebar-link">mergeOptions</a></li><li class="sidebar-sub-header"><a href="/vue-source/init/mergeOptions.html#mergefield" class="sidebar-link">mergeField</a></li></ul></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>深入组件</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/vue-source/component/" class="sidebar-link">组件介绍</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/vue-source/component/#导言" class="sidebar-link">导言</a></li></ul></li><li><a href="/vue-source/component/definition.html" class="sidebar-link">组件Vnode</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/vue-source/component/definition.html#createelement" class="sidebar-link">createElement</a></li><li class="sidebar-sub-header"><a href="/vue-source/component/definition.html#createcomponent" class="sidebar-link">createComponent</a></li><li class="sidebar-sub-header"><a href="/vue-source/component/definition.html#vue-extend" class="sidebar-link">Vue.extend</a></li></ul></li><li><a href="/vue-source/component/patch.html" class="sidebar-link">组件挂载</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/vue-source/component/patch.html#mountcomponent" class="sidebar-link">mountComponent</a></li><li class="sidebar-sub-header"><a href="/vue-source/component/patch.html#update" class="sidebar-link">_update</a></li></ul></li><li><a href="/vue-source/component/init.html" class="sidebar-link">实例化组件</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/vue-source/component/init.html#initlifecycle" class="sidebar-link">initLifecycle</a></li><li class="sidebar-sub-header"><a href="/vue-source/component/init.html#initrender" class="sidebar-link">initRender</a></li></ul></li><li><a href="/vue-source/component/lifecycle.html" class="sidebar-link">生命周期</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/vue-source/component/lifecycle.html#callhook" class="sidebar-link">callHook</a></li></ul></li><li><a href="/vue-source/component/async.html" class="sidebar-link">异步组件</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/vue-source/component/functional.html" class="sidebar-link">函数式组件</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>深入响应式</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/vue-source/responsive/" aria-current="page" class="sidebar-link">深入响应式导读</a></li><li><a href="/vue-source/responsive/initData.html" class="sidebar-link">响应式数据核心原理</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/vue-source/responsive/nextTick.html" class="sidebar-link">nextTick -- 不一样的烟火</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/vue-source/responsive/computed.html" class="sidebar-link">computed计算属性</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/vue-source/responsive/watch.html" class="sidebar-link">watch侦听属性</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/vue-source/responsive/diff.html" aria-current="page" class="active sidebar-link">组件更新</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/vue-source/responsive/diff.html#深入diff" class="sidebar-link">深入diff</a></li></ul></li><li><a href="/vue-source/responsive/props.html" class="sidebar-link">Props</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="组件更新"><a href="#组件更新" class="header-anchor">#</a> 组件更新</h1> <p>上一章我们将组件初始化全过程讲解完, 本节将结合数据响应触发组件更新去剖析组件更新原理</p> <h3 id="diff算法复杂度"><a href="#diff算法复杂度" class="header-anchor">#</a> Diff算法复杂度</h3> <p>正常来说Diff算法会如下去对比</p> <div class="custom-block tip"><p class="custom-block-title">diff</p> <ol><li><p>A元素与B元素对比</p></li> <li><p>A元素与B子元素对比</p></li> <li><p>A子元素与B元素对比</p></li></ol></div> <p>这样算的算法复杂度为 O(n^3), 这样的算法复杂度太高了, 实际上当A元素与B元素不同时, 其子节点就都不需要去对比了, 优化后的算法</p> <div class="custom-block tip"><p class="custom-block-title">diff</p> <p>A元素与B元素对比</p></div> <p>算法复杂度为 O(n), 大大的降低了算法复杂性, 从而令性能更上一层</p> <h3 id="diff算法的意义"><a href="#diff算法的意义" class="header-anchor">#</a> Diff算法的意义</h3> <p>优先重要结论: <font class="m-bold__container" data-v-3572f150><b data-v-3572f150>任何封装的Dom操作都不如原生Api性能来的好</b></font></p> <div class="custom-block tip"><p class="custom-block-title">那么Diff算法的意义是什么?</p> <p>我们可以先举个例子, 页面上一个div进行内容更改, 我们的操作通常是div.innerHTML = content, 对于结构简单的页面来说原生API是最快的, 但是当div里具有大量的标签元素, 此时使用innerHTML就会把大部分没有发生变化的节点也重新渲染了一次, 这完全是浪费的, 所以我们进行新旧节点对比后, 我们就可以将更改后的节点进行迭代, 其余节点则不动, <font class="m-bold__container" data-v-3572f150><b data-v-3572f150>保留了原有标签的状态, 例如Input的focus状态</b></font>. 看到这里会觉得Diff算法是个不错的算法, 但是每个事物都是具有两面性的, Diff算法虽然优秀, 但伴随着的就是算法计算从而引发的性能下降。</p> <p>但是纵观Vue全局组件更新创建来说, Diff算法的好处是远远高于其带来的性能下降缺点.</p></div> <h3 id="patch"><a href="#patch" class="header-anchor">#</a> patch</h3> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">function</span> <span class="token function">patch</span> <span class="token punctuation">(</span><span class="token parameter">oldVnode<span class="token punctuation">,</span> vnode<span class="token punctuation">,</span> hydrating<span class="token punctuation">,</span> removeOnly</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> insertedVnodeQueue <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isUndef</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token operator">...</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">var</span> isRealElement <span class="token operator">=</span> <span class="token function">isDef</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">.</span>nodeType<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isRealElement <span class="token operator">&amp;&amp;</span> <span class="token function">sameVnode</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">,</span> vnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// patch existing root node</span>
        <span class="token function">patchVnode</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">,</span> vnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> removeOnly<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>isRealElement<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// mounting to a real element</span>
          <span class="token comment">// check if this is server-rendered content and if we can perform</span>
          <span class="token comment">// a successful hydration.</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>oldVnode<span class="token punctuation">.</span>nodeType <span class="token operator">===</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> oldVnode<span class="token punctuation">.</span><span class="token function">hasAttribute</span><span class="token punctuation">(</span><span class="token constant">SSR_ATTR</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            oldVnode<span class="token punctuation">.</span><span class="token function">removeAttribute</span><span class="token punctuation">(</span><span class="token constant">SSR_ATTR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            hydrating <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isTrue</span><span class="token punctuation">(</span>hydrating<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">hydrate</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">,</span> vnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token function">invokeInsertHook</span><span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token keyword">return</span> oldVnode
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
              <span class="token function">warn</span><span class="token punctuation">(</span>
                <span class="token string">'The client-side rendered virtual DOM tree is not matching '</span> <span class="token operator">+</span>
                <span class="token string">'server-rendered content. This is likely caused by incorrect '</span> <span class="token operator">+</span>
                <span class="token string">'HTML markup, for example nesting block-level elements inside '</span> <span class="token operator">+</span>
                <span class="token string">'&lt;p&gt;, or missing &lt;tbody&gt;. Bailing hydration and performing '</span> <span class="token operator">+</span>
                <span class="token string">'full client-side render.'</span>
              <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
          <span class="token comment">// either not server-rendered, or hydration failed.</span>
          <span class="token comment">// create an empty node and replace it</span>
          oldVnode <span class="token operator">=</span> <span class="token function">emptyNodeAt</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// replacing existing element</span>
        <span class="token keyword">var</span> oldElm <span class="token operator">=</span> oldVnode<span class="token punctuation">.</span>elm<span class="token punctuation">;</span>
        <span class="token keyword">var</span> parentElm <span class="token operator">=</span> nodeOps<span class="token punctuation">.</span><span class="token function">parentNode</span><span class="token punctuation">(</span>oldElm<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// create new node</span>
        <span class="token function">createElm</span><span class="token punctuation">(</span>
          vnode<span class="token punctuation">,</span>
          insertedVnodeQueue<span class="token punctuation">,</span>
          <span class="token comment">// extremely rare edge case: do not insert if old element is in a</span>
          <span class="token comment">// leaving transition. Only happens when combining transition +</span>
          <span class="token comment">// keep-alive + HOCs. (#4590)</span>
          oldElm<span class="token punctuation">.</span>_leaveCb <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token operator">:</span> parentElm<span class="token punctuation">,</span>
          nodeOps<span class="token punctuation">.</span><span class="token function">nextSibling</span><span class="token punctuation">(</span>oldElm<span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// update parent placeholder node element, recursively</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>parent<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">var</span> ancestor <span class="token operator">=</span> vnode<span class="token punctuation">.</span>parent<span class="token punctuation">;</span>
          <span class="token keyword">var</span> patchable <span class="token operator">=</span> <span class="token function">isPatchable</span><span class="token punctuation">(</span>vnode<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">while</span> <span class="token punctuation">(</span>ancestor<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> cbs<span class="token punctuation">.</span>destroy<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              cbs<span class="token punctuation">.</span>destroy<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">(</span>ancestor<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            ancestor<span class="token punctuation">.</span>elm <span class="token operator">=</span> vnode<span class="token punctuation">.</span>elm<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>patchable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i$<span class="token number">1</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i$<span class="token number">1</span> <span class="token operator">&lt;</span> cbs<span class="token punctuation">.</span>create<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>i$<span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                cbs<span class="token punctuation">.</span>create<span class="token punctuation">[</span>i$<span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">(</span>emptyNode<span class="token punctuation">,</span> ancestor<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token punctuation">}</span>
              <span class="token comment">// #6513</span>
              <span class="token comment">// invoke insert hooks that may have been merged by create hooks.</span>
              <span class="token comment">// e.g. for directives that uses the &quot;inserted&quot; hook.</span>
              <span class="token keyword">var</span> insert <span class="token operator">=</span> ancestor<span class="token punctuation">.</span>data<span class="token punctuation">.</span>hook<span class="token punctuation">.</span>insert<span class="token punctuation">;</span>
              <span class="token keyword">if</span> <span class="token punctuation">(</span>insert<span class="token punctuation">.</span>merged<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// start at index 1 to avoid re-invoking component mounted hook</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i$<span class="token number">2</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i$<span class="token number">2</span> <span class="token operator">&lt;</span> insert<span class="token punctuation">.</span>fns<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i$<span class="token number">2</span><span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                  insert<span class="token punctuation">.</span>fns<span class="token punctuation">[</span>i$<span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
              <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
              <span class="token function">registerRef</span><span class="token punctuation">(</span>ancestor<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            ancestor <span class="token operator">=</span> ancestor<span class="token punctuation">.</span>parent<span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// destroy old node</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>parentElm<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">removeVnodes</span><span class="token punctuation">(</span><span class="token punctuation">[</span>oldVnode<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">.</span>tag<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">invokeDestroyHook</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    
    <span class="token function">invokeInsertHook</span><span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">,</span> isInitialPatch<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> vnode<span class="token punctuation">.</span>elm
  <span class="token punctuation">}</span>
</code></pre></div><p>我们先来看下Vue根节点变更的情况下会怎么处理</p> <ol><li>若是传入的节点不是一个真正Dom节点(组件传入的是vdom, 而Vue实例传入的是真正Dom), 会先将其变成vdom</li> <li>调用createElm将新节点重新生成, 并插入到文档里, 具体的可以去深入组件章节里了解</li> <li>当根节点具有parent则表示该组件是在另外一个组件的直接子级, parent指向了该组件父组件实例</li></ol> <h2 id="深入diff"><a href="#深入diff" class="header-anchor">#</a> 深入diff</h2> <p>Vue2.x采用的diff算法，与React不同，React Diff算法有个需要优化的地方
React:
old: abcd
new: dabc
React的操作是将abc移动到d后面，而不是将d移动到a前面，这里一步能完成的但是分了三步</p> <p>Vue2.x则是采用双端对比的diff算法，每次循环对比都会分四步走:</p> <ol><li>oldChildren头节点对比newChildren头节点，若是对比上了表示可以复用，那么各自将指针移动到下一步，跳出循环到下一个循环</li> <li>oldChildren尾节点对比newChildren尾节点，若是对比上了表示可以复用，那么各自将指针移动到上一步，跳出循环到下一个循环</li> <li>oldChildren头节点对比newChildren尾节点，若是对比上了表示可以复用，oldChildren往后移一步，newChildren往前移一步，此时将oldChildren里的头节点移动到oldChildren尾节点的后面，跳出循环到下一个循环</li> <li>oldChildren尾节点对比newChildren头节点，若是对比上了表示可以复用，oldChildren往前移一步，newChildren往后移一步，此时将oldChildren里的尾节点移动到oldChildren头节点的前面，跳出循环到下一个循环</li></ol> <img src="/vue-source/assets/img/diff1.c6dfefa7.png"> <img src="/vue-source/assets/img/diff2.ff0c5281.png"> <img src="/vue-source/assets/img/diff3.50b3b43f.png"> <p>还有一种情况就是双端检测都对比不上，如下图，那么Vue就会对newChildren头部节点进行key对比去找出oldchildren里的对应的key，也有两种情况</p> <ol><li>oldChildren里存在对应的key， 将找到的节点移动到oldStartIndex前面，并将oldStartIndex往后移</li> <li>不存在对应的key，直接创建一个新节点放在头部
<img src="/vue-source/assets/img/diff4.db76d1a9.png"></li></ol> <div class="m-wx" data-v-23a31faf><img src="/vue-source/assets/img/gzh.866bd6bf.jpg" alt="前端马丁" class="m-wx__img" data-v-23a31faf>
  关注我, 不迷路
</div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/vue-source/responsive/watch.html" class="prev">
        watch侦听属性
      </a></span> <span class="next"><a href="/vue-source/responsive/props.html">
        Props
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/vue-source/assets/js/app.b682844e.js" defer></script><script src="/vue-source/assets/js/2.f913fa43.js" defer></script><script src="/vue-source/assets/js/3.eb811a71.js" defer></script><script src="/vue-source/assets/js/6.31106f99.js" defer></script><script src="/vue-source/assets/js/4.cf36d000.js" defer></script>
  </body>
</html>
